#!/usr/bin/env node

/**
 * Clean Report Titles Script
 * 
 * Removes AI prompts from H1 headings and uses proper titles from filenames.
 * Handles reports generated by AI that include the original prompt as H1.
 */

const fs = require('fs');
const path = require('path');

const REPORTS_DIR = path.join(__dirname, '..', 'content', 'reports');

// Map of filename patterns to clean titles
function extractTitleFromFilename(filename) {
  // Remove .md extension
  let title = filename.replace(/\.md$/i, '');
  
  // Remove leading numbers and dots (e.g., "Report 1.1 - ")
  title = title.replace(/^Report\s+[\d.]+\s*[-â€“â€”]\s*/i, '');
  
  // Replace hyphens and underscores with spaces
  title = title.replace(/[-_]/g, ' ');
  
  // Clean up multiple spaces
  title = title.replace(/\s+/g, ' ').trim();
  
  return title;
}

function isPromptHeading(heading) {
  const promptIndicators = [
    'create report',
    'please',
    'revise',
    'write a',
    'now compile',
    'yes please',
    'i love this',
    'this report is',
    'give examples'
  ];
  
  const lowerHeading = heading.toLowerCase();
  return promptIndicators.some(indicator => lowerHeading.includes(indicator));
}

function cleanReportTitle(filepath, filename) {
  console.log(`\nðŸ“„ Processing: ${filename}`);
  
  const content = fs.readFileSync(filepath, 'utf8');
  
  // Find the first H1 heading
  const h1Match = content.match(/^#\s+(.+)$/m);
  
  if (!h1Match) {
    console.log('  âš ï¸  No H1 heading found');
    return false;
  }
  
  const currentTitle = h1Match[1].trim();
  
  // Check if it looks like a prompt
  if (!isPromptHeading(currentTitle)) {
    console.log(`  âœ“ Title already clean: "${currentTitle}"`);
    return false;
  }
  
  console.log(`  âœ— Prompt detected: "${currentTitle.substring(0, 60)}..."`);
  
  // Extract proper title from filename
  const newTitle = extractTitleFromFilename(filename);
  console.log(`  â†’ New title: "${newTitle}"`);
  
  // Replace the H1 heading
  const updatedContent = content.replace(
    /^#\s+.+$/m,
    `# ${newTitle}`
  );
  
  // Write back to file
  fs.writeFileSync(filepath, updatedContent, 'utf8');
  console.log('  âœ“ Title updated');
  
  return true;
}

function cleanAllReports() {
  console.log('ðŸ§¹ Cleaning Report Titles\n');
  console.log('='.repeat(50));
  
  if (!fs.existsSync(REPORTS_DIR)) {
    console.error(`\nâŒ Reports directory not found: ${REPORTS_DIR}`);
    process.exit(1);
  }
  
  const files = fs.readdirSync(REPORTS_DIR)
    .filter(file => file.endsWith('.md') && !file.startsWith('_'))
    .sort();
  
  if (files.length === 0) {
    console.log('\nðŸ“­ No markdown files found');
    process.exit(0);
  }
  
  console.log(`\nFound ${files.length} report(s)\n`);
  
  let cleaned = 0;
  let skipped = 0;
  
  files.forEach(file => {
    const filepath = path.join(REPORTS_DIR, file);
    const wasChanged = cleanReportTitle(filepath, file);
    
    if (wasChanged) {
      cleaned++;
    } else {
      skipped++;
    }
  });
  
  console.log('\n' + '='.repeat(50));
  console.log('\nðŸ“Š Summary:');
  console.log(`   âœ“ Cleaned: ${cleaned} file(s)`);
  console.log(`   âŠ˜ Skipped: ${skipped} file(s)`);
  console.log(`   ðŸ“ Total: ${files.length} file(s)`);
  
  if (cleaned > 0) {
    console.log('\nðŸ’¡ Tip: Run "npm run import-reports" to see the updated titles!\n');
  } else {
    console.log('\nâœ¨ All titles are already clean!\n');
  }
}

cleanAllReports();

